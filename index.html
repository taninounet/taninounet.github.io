<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>MyFPL</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="navbar-container">
        <div class="navbar">
            <a href="#" onclick="loadSubreddit('fantasypl')" class="logo-link">
                <img src="https://www.premierleague.com/resources/rebrand/v7.151.1/i/elements/pl-main-logo.png" alt="MyFPL Logo" class="logo">
            </a>
            <div class="nav-links">
                <a href="#" onclick="loadSubreddit('fantasypl')">FantasyPL</a>
                <a href="#" onclick="loadCombined()">All</a>
                <a href="#" onclick="loadSubreddit('coys')">Spurs</a>
                <a href="#" onclick="loadSubreddit('reddevils')">ManUtd</a>
                <a href="#" onclick="loadSubreddit('mcfc')">ManCity</a>
                <a href="#" onclick="loadSubreddit('chelseafc')">Chelsea</a>
                <a href="#" onclick="loadSubreddit('gunners')">Arsenal</a>
                <a href="#" onclick="loadSubreddit('liverpoolfc')">Liverpool</a>
                <a href="#" onclick="loadSubreddit('crystalpalace')">Palace</a>
            </div>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Searchâ€¦" onkeypress="if(event.key==='Enter') searchSubreddit()">
                <button onclick="searchSubreddit()">
                    <img src="https://img.icons8.com/ios-glyphs/30/ffffff/search.png" alt="Search">
                </button>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div id="content"></div>
        <div id="comments-section" class="hidden">
            <div id="comments-header">
                <h2>Comments</h2>
                <button onclick="closeComments()">X</button>
            </div>
            <div id="comments-container" class="comments-container"></div>
        </div>
    </div>

    <script>
    window.addEventListener('load', init);
    const subMap = { fantasypl:'FantasyPL', coys:'Spurs', reddevils:'ManUtd', mcfc:'ManCity', chelseafc:'Chelsea', gunners:'Arsenal', liverpoolfc:'Liverpool', crystalpalace:'Palace' };
    let after=null, currentSubreddit='', isCombined=false, isLoading=false;

    function init() {
      loadSubreddit('fantasypl');
      document.getElementById('content').addEventListener('scroll', e=>{
        const f=e.target;
        if(f.scrollTop+f.clientHeight>=f.scrollHeight-50) loadMorePosts();
      });
    }

    async function searchSubreddit() {
      const q=document.getElementById('search-input').value.trim();
      if(!q) return;
      isCombined=false;
      loadSubreddit(q);
    }

    async function loadSubreddit(subreddit, reset=true) {
      if(isLoading) return;
      isCombined=false; currentSubreddit=subreddit;
      if(reset){ after=null; document.getElementById('content').innerHTML=''; closeComments(); }
      isLoading=true;
      const r=await fetch(`https://www.reddit.com/r/${subreddit}/new.json?limit=10${after?`&after=${after}`:''}`);
      const j=await r.json(); after=j.data.after;
      renderPosts(j.data.children.map(c=>c.data));
      isLoading=false;
    }

    async function loadCombined(reset=true) {
      if(isLoading) return;
      isCombined=true;
      if(reset){ after=null; document.getElementById('content').innerHTML=''; closeComments(); }
      isLoading=true;
      const subs=['coys','reddevils','mcfc','chelseafc','gunners','liverpoolfc','crystalpalace'];
      const all=await Promise.all(subs.map(s=>fetch(`https://www.reddit.com/r/${s}/new.json?limit=10`).then(r=>r.json()).then(d=>d.data.children.map(c=>c.data))));
      const flat=all.flat().sort((a,b)=>b.created_utc-a.created_utc);
      renderPosts(flat);
      isLoading=false;
    }

    function loadMorePosts() {
      if(isCombined||!after) return;
      loadSubreddit(currentSubreddit,false);
    }

    function clearContent() {
      document.getElementById('content').innerHTML='';
      closeComments();
    }

    function renderPosts(posts){
      const cont=document.getElementById('content');
      posts.forEach(post=>{
        const el=document.createElement('div'); el.className='post';
        el.addEventListener('click', e=>{
          if(e.target.closest('a')||e.target.closest('button')) return;
          loadComments(post.id,post.subreddit);
        });
        const t=timeAgo(post.created_utc), s=subMap[post.subreddit]||post.subreddit;
        const meta=isCombined?`${s} | ${t} | ${post.num_comments} comments`:`${t} | ${post.num_comments} comments`;
        let html=`<div class="post-header">
            <div class="post-thumbnail"><img src="${post.thumbnail&&post.thumbnail.startsWith('http')?post.thumbnail:'https://www.redditinc.com/assets/images/site/reddit-logo.png'}"/></div>
            <div class="post-details"><span class="post-title">${post.title}</span><div class="post-meta">${meta}</div></div>
        </div>`;
        let m=[];
        if(post.preview&&post.preview.images) m=post.preview.images.map(i=>({type:'image',url:i.source.url.replace(/&amp;/g,'&')}));
        if(post.is_video&&post.media?.reddit_video) m.push({type:'video',url:post.media.reddit_video.fallback_url});
        if(m.length){
          html+='<div class="post-media-container">';
          m.forEach(x=>{ html+=x.type==='image'?`<img src="${x.url}" class="media-item"/>`:`<video src="${x.url}" controls loop class="media-item"></video>`; });
          html+='</div>';
        }
        el.innerHTML=html;
        cont.appendChild(el);
      });
    }

    async function loadComments(id,sub){
      const r=await fetch(`https://www.reddit.com/r/${sub}/comments/${id}.json?sort=best`);
      const j=await r.json();
      const cm=j[1].data.children.filter(c=>c.kind==='t1').map(c=>c.data);
      const cc=document.getElementById('comments-container'); cc.innerHTML='';
      cm.forEach(c=>cc.appendChild(makeComment(c,id,sub)));
      document.getElementById('comments-section').classList.remove('hidden');
    }

    function closeComments(){
      document.getElementById('comments-section').classList.add('hidden');
    }

    function makeComment(d,postId,sub){
      const div=document.createElement('div'); div.className='comment';
      const rcount=d.replies?.data?.children.filter(r=>r.kind==='t1').length||0;
      const t=timeAgo(d.created_utc);
      div.innerHTML=`<div class="comment-header"><span class="comment-author">${d.author}</span><span class="comment-time">${t}</span></div><div class="comment-body">${d.body}</div>`;
      if(rcount){
        div.addEventListener('click', async e=>{
          if(div.classList.contains('loaded')) return;
          e.stopPropagation(); div.classList.add('loaded');
          const r2=await fetch(`https://www.reddit.com/r/${sub}/comments/${postId}/_/${d.id}.json?sort=best`);
          const j2=await r2.json();
          const sc=j2[1].data.children.filter(c=>c.kind==='t1').map(c=>c.data);
          const ct=document.createElement('div'); ct.className='comment-replies';
          sc.forEach(x=>ct.appendChild(makeComment(x,postId,sub)));
          div.appendChild(ct);
        });
      }
      return div;
    }

    function timeAgo(s){
      const d=Math.floor(Date.now()/1000-s);
      if(d>31536000) return Math.floor(d/31536000)+'y';
      if(d>2592000) return Math.floor(d/2592000)+'mo';
      if(d>86400) return Math.floor(d/86400)+'d';
      if(d>3600) return Math.floor(d/3600)+'h';
      if(d>60) return Math.floor(d/60)+'m';
      return d+'s';
    }
    </script>
</body>
</html>
