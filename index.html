<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Reddit-style Forum</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>r/<span id="subreddit-title"></span></h1>
    <input id="subreddit-input" placeholder="Enter a subreddit" />
    <button id="load-subreddit">Load</button>
  </header>

  <main>
    <section id="posts-section">
      <div id="posts-container"></div>
    </section>

    <section id="comments-section" class="hidden">
      <button id="back-to-posts">← Back to posts</button>
      <h2>Comments</h2>
      <!-- injected post content / link goes here -->
      <div id="comments-container"></div>
    </section>
  </main>

  <script>
    // Basic helpers
    function timeAgo(utcSeconds) {
      const delta = Date.now()/1000 - utcSeconds;
      if (delta < 60) return `${Math.floor(delta)}s ago`;
      if (delta < 3600) return `${Math.floor(delta/60)}m ago`;
      if (delta < 86400) return `${Math.floor(delta/3600)}h ago`;
      return `${Math.floor(delta/86400)}d ago`;
    }

    // Load subreddit posts
    async function loadSubreddit(sub) {
      document.getElementById('subreddit-title').textContent = sub;
      const res = await fetch(`https://www.reddit.com/r/${sub}.json`);
      const json = await res.json();
      const posts = json.data.children.map(c => c.data);
      const pc = document.getElementById('posts-container');
      pc.innerHTML = '';
      posts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          <h3 class="post-title">${p.title}</h3>
          ${p.preview?.images
             ? `<div class="post-media-container">
                  ${p.preview.images
                    .map(img => {
                      const url = img.source.url.replace(/&amp;/g, '&');
                      return `<img class="media-item" src="${url}" />`;
                    })
                    .join('')}
                </div>`
             : ''}
          <button class="view-comments" data-id="${p.id}" data-sub="${sub}">
            View Comments
          </button>
        `;
        pc.appendChild(div);
      });

      // attach comment-view buttons
      document.querySelectorAll('.view-comments').forEach(btn => {
        btn.addEventListener('click', () => {
          loadComments(btn.dataset.id, btn.dataset.sub);
        });
      });
    }

    // Load comments + original post content/link
    async function loadComments(postId, sub) {
      const res = await fetch(`https://www.reddit.com/r/${sub}/comments/${postId}.json?sort=best`);
      const [postJson, commentsJson] = await res.json();
      const postData = postJson.data.children[0].data;

      const cc = document.getElementById('comments-container');
      let html = '';

      // Self-text or HTML
      if (postData.selftext_html) {
        html += `<div class="post-content">${postData.selftext_html}</div>`;
      } else if (postData.selftext) {
        html += `<div class="post-content">${postData.selftext}</div>`;
      }
      // External link
      if (!postData.is_self && postData.url) {
        html += `<div class="post-link">
                   <a href="${postData.url}" target="_blank">${postData.url}</a>
                 </div>`;
      }
      cc.innerHTML = html;

      // Top-level comments
      const topComments = commentsJson.data.children
        .filter(c => c.kind === 't1')
        .map(c => c.data);
      topComments.forEach(c => cc.appendChild(makeComment(c, postId, sub)));

      document.getElementById('comments-section').classList.remove('hidden');
      document.getElementById('posts-section').classList.add('hidden');
    }

    // Recursive comment builder with toggle-loading
    function makeComment(d, postId, sub) {
      const div = document.createElement('div');
      div.className = 'comment';

      const repliesCount = d.replies?.data?.children
        .filter(r => r.kind === 't1').length || 0;
      const t = timeAgo(d.created_utc);

      div.innerHTML = `
        <div class="comment-header">
          <span class="comment-author">${d.author}</span>
          <span class="comment-time">${t}</span>
          ${repliesCount > 0 
            ? `<span class="comment-replies-count">${repliesCount} replies</span>`
            : ''}
        </div>
        <div class="comment-body">${d.body}</div>
      `;

      if (repliesCount > 0) {
        div.addEventListener('click', async e => {
          e.stopPropagation();
          let childContainer = div.querySelector('.comment-replies');
          if (childContainer) {
            childContainer.classList.toggle('hidden');
            return;
          }
          const r2 = await fetch(
            `https://www.reddit.com/r/${sub}/comments/${postId}/_/${d.id}.json?sort=best`
          );
          const j2 = await r2.json();
          const subComments = j2[1].data.children
            .filter(c => c.kind === 't1')
            .map(c => c.data);

          childContainer = document.createElement('div');
          childContainer.className = 'comment-replies';
          subComments.forEach(sc => childContainer.appendChild(makeComment(sc, postId, sub)));
          div.appendChild(childContainer);
        });
      }

      return div;
    }

    // “Back to posts” button
    document.getElementById('back-to-posts').addEventListener('click', () => {
      document.getElementById('comments-section').classList.add('hidden');
      document.getElementById('posts-section').classList.remove('hidden');
    });

    // Initial binding
    document.getElementById('load-subreddit').addEventListener('click', () => {
      const sub = document.getElementById('subreddit-input').value.trim();
      if (sub) loadSubreddit(sub);
    });
  </script>
</body>
</html>
