<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>MyFPL</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="navbar-container">
        <div class="navbar">
            <a href="#" onclick="init()" class="logo-link">
                <img src="https://www.premierleague.com/resources/rebrand/v7.151.1/i/elements/pl-main-logo.png" alt="MyFPL Logo" class="logo">
            </a>
            <div class="nav-links">
                <a href="#" onclick="loadCombined()">All</a>
                <a href="#" onclick="loadSubreddit('coys')">Spurs</a>
                <a href="#" onclick="loadSubreddit('reddevils')">ManUtd</a>
                <a href="#" onclick="loadSubreddit('mcfc')">ManCity</a>
                <a href="#" onclick="loadSubreddit('chelseafc')">Chelsea</a>
                <a href="#" onclick="loadSubreddit('gunners')">Arsenal</a>
                <a href="#" onclick="loadSubreddit('liverpoolfc')">Liverpool</a>
                <a href="#" onclick="loadSubreddit('crystalpalace')">Palace</a>
            </div>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search…" onkeypress="if(event.key==='Enter') searchSubreddit()">
                <button onclick="searchSubreddit()">
                    <img src="https://img.icons8.com/ios-glyphs/30/ffffff/search.png" alt="Search Icon">
                </button>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div id="content"><!-- posts here --></div>
        <div id="comments-section" class="hidden">
            <div id="comments-header">
                <h2>Comments</h2>
                <button onclick="closeComments()">X</button>
            </div>
            <!-- post preview will get injected here -->
            <div id="post-content" class="post-content"></div>
            <div id="comments-container" class="comments-container"></div>
        </div>
    </div>

    <button id="load-more" style="display:none;">Load More</button>

    <script>
        let after = null;
        let currentSubreddit = '';
        let isCombined = false;

        function init() {
            const btn = document.getElementById('load-more');
            btn.addEventListener('click', loadMorePosts);
            btn.addEventListener('touchstart', e => { e.preventDefault(); loadMorePosts(); });
            loadSubreddit('fantasypl');
        }

        async function searchSubreddit() {
            const q = document.getElementById('search-input').value.trim();
            if (!q) return;
            isCombined = false;
            loadSubreddit(q);
        }

        async function loadSubreddit(subreddit, reset = true) {
            isCombined = false;
            currentSubreddit = subreddit;
            if (reset) {
                after = null;
                clearContent();
            }
            const url = `https://www.reddit.com/r/${subreddit}/new.json?limit=10${after?`&after=${after}`:''}`;
            const res = await fetch(url);
            const obj = await res.json();
            after = obj.data.after;
            renderPosts(obj.data.children.map(c=>c.data));
            toggleLoadMore();
        }

        async function loadCombined(reset = true) {
            isCombined = true;
            if (reset) {
                after = null;
                clearContent();
            }
            const subs = ['coys','reddevils','mcfc','chelseafc','gunners','liverpoolfc','crystalpalace'];
            const all = await Promise.all(
                subs.map(s => fetch(`https://www.reddit.com/r/${s}/new.json?limit=10`).then(r=>r.json()).then(d=>d.data.children.map(c=>c.data)))
            );
            let flat = all.flat();
            flat.sort((a,b)=>b.created_utc - a.created_utc);
            renderPosts(flat.slice(0,10));
            document.getElementById('load-more').style.display='none';
        }

        async function loadMorePosts() {
            const btn = document.getElementById('load-more');
            btn.disabled = true;
            btn.textContent = 'Loading…';
            if (isCombined) {
                // no pagination for combined
            } else {
                await loadSubreddit(currentSubreddit, false);
            }
            btn.disabled = false;
            btn.textContent = 'Load More';
        }

        function clearContent() {
            document.getElementById('content').innerHTML = '';
            closeComments();
        }

        function toggleLoadMore() {
            document.getElementById('load-more').style.display = after ? 'block' : 'none';
        }

        function renderPosts(posts) {
            const container = document.getElementById('content');
            posts.forEach(post => {
                const el = document.createElement('div');
                el.className = 'post';
                el.addEventListener('click', e => {
                    if (e.target.closest('a') || e.target.closest('button')) return;
                    loadComments(post.id, post.subreddit);
                });

                const thumb = (post.thumbnail && post.thumbnail.startsWith('http')) ? post.thumbnail
                              : 'https://www.redditinc.com/assets/images/site/reddit-logo.png';
                const isExt = !post.url.includes('reddit.com');
                const timeSince = timeAgo(post.created_utc);

                el.innerHTML = `
                    <div class="post-thumbnail"><img src="${thumb}" alt=""></div>
                    <div class="post-details">
                      ${isExt
                        ? `<a href="${post.url}" target="_blank" class="post-title">${post.title}</a>`
                        : `<span class="post-title">${post.title}</span>`}
                      <div class="post-meta">${timeSince} | ${post.num_comments} comments</div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        async function loadComments(postId, subreddit) {
            const res = await fetch(`https://www.reddit.com/r/${subreddit}/comments/${postId}.json?sort=best`);
            const data = await res.json();
            const postInfo = data[0].data.children[0].data;
            const comments = data[1].data.children.filter(c=>c.kind==='t1').map(c=>c.data);

            // show preview
            const preview = document.getElementById('post-content');
            let html = `<h3>${postInfo.title}</h3>`;
            if (postInfo.url && !postInfo.url.includes('reddit.com')) {
                html += `<p><a href="${postInfo.url}" target="_blank">${postInfo.url}</a></p>`;
            }
            if (postInfo.selftext) {
                html += `<p>${postInfo.selftext}</p>`;
            }
            // gather media
            let media = [];
            if (postInfo.preview && postInfo.preview.images) {
                media = postInfo.preview.images.map(img => ({type:'image', url: img.source.url.replace(/&amp;/g,'&')}));
            }
            if (postInfo.is_video && postInfo.media?.reddit_video) {
                media.push({type:'video', url: postInfo.media.reddit_video.fallback_url});
            }
            // render media
            if (media.length>0) {
                if (media.length <= 3) {
                    media.forEach(m=>{
                        if (m.type==='image') html+=`<img src="${m.url}" class="post-media">`;
                        else html+=`<video src="${m.url}" controls loop class="post-media"></video>`;
                    });
                } else {
                    html += `
                      <div class="carousel">
                        <button class="carousel-button prev">‹</button>
                        <div class="carousel-media"><img class="carousel-item"></div>
                        <button class="carousel-button next">›</button>
                      </div>
                    `;
                }
            }
            preview.innerHTML = html;
            document.getElementById('comments-section').classList.remove('hidden');

            // init carousel if needed
            if (media.length > 3) {
                let idx = 0;
                const imgEl = preview.querySelector('.carousel-item');
                const prev = preview.querySelector('.carousel-button.prev');
                const next = preview.querySelector('.carousel-button.next');
                const show = () => { imgEl.src = media[idx].url; };
                show();
                prev.onclick = () => { idx = (idx-1+media.length)%media.length; show(); };
                next.onclick = () => { idx = (idx+1)%media.length; show(); };
            }

            // render comments
            const cc = document.getElementById('comments-container');
            cc.innerHTML = '';
            comments.forEach(c => cc.appendChild(makeComment(c)));
        }

        function closeComments() {
            document.getElementById('comments-section').classList.add('hidden');
        }

        function makeComment(data) {
            const div = document.createElement('div');
            div.className = 'comment';
            const timeSince = timeAgo(data.created_utc);
            div.innerHTML = `
              <div class="comment-header">
                <span class="comment-author">${data.author}</span>
                <span class="comment-time">${timeSince}</span>
              </div>
              <div class="comment-body">${data.body}</div>
            `;
            // replies
            const replies = data.replies?.data?.children.filter(r=>r.kind==='t1').map(r=>r.data) || [];
            if (replies.length) {
                const container = document.createElement('div');
                container.className = 'comment-replies hidden';
                replies.forEach(r=>container.appendChild(makeComment(r)));
                div.appendChild(container);
                // anywhere on the comment toggles replies
                div.addEventListener('click', e => {
                    if (e.target.closest('a')) return;
                    container.classList.toggle('hidden');
                });
            }
            return div;
        }

        function timeAgo(sec) {
            const s = Math.floor(Date.now()/1000 - sec);
            if (s>31536000) return Math.floor(s/31536000)+'y';
            if (s>2592000)  return Math.floor(s/2592000)+'mo';
            if (s>86400)    return Math.floor(s/86400)+'d';
            if (s>3600)     return Math.floor(s/3600)+'h';
            if (s>60)       return Math.floor(s/60)+'m';
            return s+'s';
        }
    </script>
</body>
</html>
